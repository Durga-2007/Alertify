{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    #map {
        height: 70vh;
        width: 100%;
        border-radius: 12px;
    }

    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>

<div class="row mt-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="bi bi-map-fill text-warning me-2"></i>Safety Map</h3>
            <button class="btn btn-sm btn-outline-light" onclick="locateUser()">
                <i class="bi bi-crosshair"></i> My Location
            </button>
        </div>

        <div id="map"></div>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-danger flex-grow-1" onclick="addZone('unsafe')">
                <i class="bi bi-exclamation-octagon"></i> Mark Unsafe
            </button>
            <button class="btn btn-outline-success flex-grow-1" onclick="addZone('safe')">
                <i class="bi bi-shield-check"></i> Mark Safe
            </button>
        </div>
    </div>
</div>

<script>
    // Initialize Map centered on India (fallback)
    var map = L.map('map').setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var userMarker = null;
    var selectedMarker = null; // New marker for custom selection

    // Custom Icons
    var userIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
    });

    var selectedIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
    });

    // Map Click Event to Select Location
    map.on('click', function (e) {
        if (selectedMarker) {
            map.removeLayer(selectedMarker);
        }
        selectedMarker = L.marker(e.latlng, { icon: selectedIcon }).addTo(map)
            .bindPopup("Selected Location").openPopup();
    });

    // Locate User Function
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Update View
                map.setView([lat, lng], 15);

                // Update Marker
                if (userMarker) {
                    userMarker.setLatLng([lat, lng]);
                } else {
                    userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map)
                        .bindPopup("<b>You are here</b>").openPopup();
                }

                // Add Circle to show accuracy/safe radius
                L.circle([lat, lng], {
                    color: '#0d6efd',
                    fillColor: '#0d6efd',
                    fillOpacity: 0.1,
                    radius: 200
                }).addTo(map);

            }, error => {
                alert("Could not get location: " + error.message);
            }, { enableHighAccuracy: true });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // Interactive Zone Adding
    async function addZone(type) {
        let targetLatLng;

        if (selectedMarker) {
            targetLatLng = selectedMarker.getLatLng();
        } else if (userMarker) {
            if (confirm("No location selected on map. Use your current location?")) {
                targetLatLng = userMarker.getLatLng();
            } else {
                return;
            }
        } else {
            alert("Please click on the map to select a location first!");
            return;
        }

        const color = type === 'safe' ? 'green' : 'red';
        const msg = type === 'safe' ? 'Marked as Safe Zone' : 'Reported as Unsafe Area';

        try {
            // Save to Backend
            const response = await fetch('/api/zones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lat: targetLatLng.lat,
                    lon: targetLatLng.lng,
                    type: type,
                    description: msg
                })
            });

            if (response.ok) {
                // Add to Map
                L.circle(targetLatLng, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    radius: 300
                }).addTo(map).bindPopup(msg);

                // Remove selection marker
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                    selectedMarker = null;
                }

                alert(msg + " saved!");
            } else {
                alert("Failed to save zone. Please try again.");
            }
        } catch (e) {
            console.error(e);
            alert("Error saving zone.");
        }
    }

    // Load Existing Zones
    async function loadZones() {
        try {
            const res = await fetch('/api/zones');
            const zones = await res.json();

            zones.forEach(zone => {
                const color = zone.type === 'safe' ? 'green' : 'red';
                const msg = zone.desc || (zone.type === 'safe' ? 'Safe Zone' : 'Unsafe Area');

                L.circle([zone.lat, zone.lon], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    radius: 300
                }).addTo(map).bindPopup(msg);
            });
        } catch (e) {
            console.error("Failed to load zones", e);
        }
    }

    // Auto locate and load zones
    locateUser();
    loadZones();

</script>
{% endblock %}